<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樂樂單字特訓 (V11.1 修正版)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --primary-color: #2563eb;
            --text-main: #334155;
            
            --color-correct: #10b981;    /* Green */
            --color-incorrect: #ef4444;  /* Red */
            --color-neutral: #64748b;
            
            /* POS Colors */
            --color-noun: #3b82f6;
            --color-noun-bg: #eff6ff;
            --color-verb: #ef4444;
            --color-verb-bg: #fef2f2;
            --color-adj: #10b981;
            --color-adj-bg: #ecfdf5;
            --color-adv: #f59e0b;
            --color-adv-bg: #fffbeb;
            --color-other: #8b5cf6;
            --color-other-bg: #f5f3ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            padding-bottom: 120px;
        }

        /* Header */
        header {
            width: 100%;
            max-width: 1200px;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #1e293b;
            letter-spacing: 1px;
        }

        /* Controls Area */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 24px;
            border-radius: 50px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .speed-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #cbd5e1;
            background: #f1f5f9;
            color: #334155;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .speed-btn:active { transform: scale(0.9); background: #e2e8f0; }
        #speed-display { font-family: monospace; font-size: 1.1rem; font-weight: bold; color: var(--primary-color); width: 45px; text-align: center; }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }

        .legend-item {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-weight: 500;
        }

        /* Accordion */
        .accordion-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .accordion-item {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .accordion-header {
            padding: 18px 24px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: background 0.2s;
        }

        .accordion-header:hover { background: #f8fafc; }
        .accordion-header.active { border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .group-title { font-weight: 700; color: #334155; font-size: 1.1rem; }
        .accordion-icon { transition: transform 0.3s; color: #94a3b8; }
        .accordion-header.active .accordion-icon { transform: rotate(180deg); }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: #f8fafc;
        }

        /* Tab Bar inside Accordion */
        .tab-bar {
            display: flex;
            gap: 8px;
            padding: 15px 15px 5px 15px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            align-items: center;
        }

        .tab-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .tab-btn:hover { background: #f1f5f9; }

        .tab-btn.active {
            background: var(--color-neutral);
            color: white;
            border-color: var(--color-neutral);
        }

        .tab-btn.active.unanswered { background: var(--primary-color); border-color: var(--primary-color); }
        .tab-btn.active.correct { background: var(--color-correct); border-color: var(--color-correct); }
        .tab-btn.active.incorrect { background: var(--color-incorrect); border-color: var(--color-incorrect); }

        .tab-btn.reset {
            margin-left: auto; /* Push to right */
            border-color: #cbd5e1;
            color: #475569;
            background: #f8fafc;
        }
        
        .tab-btn.reset:active { background: #e2e8f0; transform: scale(0.95); }

        .badge {
            font-size: 0.75rem;
            padding: 1px 6px;
            border-radius: 10px;
            background: rgba(0,0,0,0.15);
            font-weight: 700;
            color: inherit;
        }

        .stats-text {
            font-size: 0.85rem;
            color: #475569;
            margin-left: 8px;
            font-weight: 600;
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Grid System */
        .card-grid {
            display: grid;
            padding: 15px;
            gap: 12px;
            min-height: 100px; /* Avoid collapse when empty */
            /* Desktop Default: 4 Columns */
            grid-template-columns: repeat(4, 1fr);
        }

        /* Mobile: 1 Column (Fixed) */
        @media (max-width: 767px) {
            .card-grid { 
                grid-template-columns: 1fr; 
                gap: 10px;
                padding: 10px;
            }
            .tab-bar { padding-bottom: 10px; }
        }
        
        /* Tablet: 3 Columns */
        @media (min-width: 768px) and (max-width: 1023px) {
            .card-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* Card Component */
        .card-wrapper {
            position: relative; 
            height: 280px; /* Fixed height */
        }

        .card-container {
            background: transparent;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            cursor: pointer;
            position: relative;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
        }

        .card-container.flipped .card-inner { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 16px;
            border: 2px solid transparent;
            /* Leave space at bottom for buttons */
            padding-bottom: 50px; 
        }

        .card-front { z-index: 2; transform: rotateY(0deg); }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; }

        /* Grading Buttons (Floating on Card) */
        .grade-controls {
            position: absolute;
            bottom: 12px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 20; 
            pointer-events: none; 
        }

        .grade-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: transform 0.1s, background 0.2s;
            background: white;
            font-weight: bold;
        }

        .grade-btn:active { transform: scale(0.9); }
        .btn-correct { color: var(--color-correct); border: 2px solid var(--color-correct); }
        .btn-incorrect { color: var(--color-incorrect); border: 2px solid var(--color-incorrect); }
        
        .btn-correct:hover { background: #ecfdf5; }
        .btn-incorrect:hover { background: #fef2f2; }

        /* Content */
        .word-front { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin-bottom: 8px; word-break: break-word; }
        .word-ipa { font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif; color: #64748b; font-size: 1rem; margin-bottom: 12px; }
        
        .top-section { width: 100%; margin-bottom: 10px; }
        .pos-tag { font-size: 0.8rem; padding: 3px 10px; border-radius: 12px; font-weight: 500; margin-bottom: 6px; display: inline-block; }
        .word-back-cn { font-size: 1.5rem; font-weight: 700; color: #334155; margin-bottom: 4px; line-height: 1.3; }
        
        .sentence-box { 
            background: #f8fafc; 
            border-radius: 8px; 
            padding: 10px; 
            width: 100%; 
            font-size: 0.9rem; 
            color: #475569; 
            font-style: italic; 
            text-align: left; 
            line-height: 1.4; 
            max-height: 80px; 
            overflow-y: auto; 
        }

        /* Audio Btn */
        .audio-btn { background: none; border: 1px solid #cbd5e1; color: #64748b; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .audio-btn:hover { background: #f1f5f9; color: var(--primary-color); border-color: var(--primary-color); }
        .audio-btn.playing { color: #10b981; border-color: #10b981; background: #ecfdf5; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* Themes */
        .theme-noun .card-face { border-top: 5px solid var(--color-noun); } .theme-noun .pos-tag { background: var(--color-noun-bg); color: var(--color-noun); }
        .theme-verb .card-face { border-top: 5px solid var(--color-verb); } .theme-verb .pos-tag { background: var(--color-verb-bg); color: var(--color-verb); }
        .theme-adj .card-face { border-top: 5px solid var(--color-adj); } .theme-adj .pos-tag { background: var(--color-adj-bg); color: var(--color-adj); }
        .theme-adv .card-face { border-top: 5px solid var(--color-adv); } .theme-adv .pos-tag { background: var(--color-adv-bg); color: var(--color-adv); }
        .theme-other .card-face { border-top: 5px solid var(--color-other); } .theme-other .pos-tag { background: var(--color-other-bg); color: var(--color-other); }

        /* Legend */
        .legend-noun { background: var(--color-noun-bg); color: var(--color-noun); border-color: var(--color-noun); }
        .legend-verb { background: var(--color-verb-bg); color: var(--color-verb); border-color: var(--color-verb); }
        .legend-adj { background: var(--color-adj-bg); color: var(--color-adj); border-color: var(--color-adj); }
        .legend-adv { background: var(--color-adv-bg); color: var(--color-adv); border-color: var(--color-adv); }
        .legend-other { background: var(--color-other-bg); color: var(--color-other); border-color: var(--color-other); }

        /* Helper */
        .locked { pointer-events: none; }
        .empty-msg { grid-column: 1 / -1; text-align: center; color: #94a3b8; padding: 30px; font-size: 1rem; }

        /* Scroll Navigation */
        .scroll-nav {
            position: fixed;
            bottom: 25px;
            right: 25px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        .nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .nav-btn:active { transform: scale(0.92); background: #f1f5f9; }
        .nav-btn.micro { width: 40px; height: 40px; }
        .nav-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }

    </style>
</head>
<body>

    <header>
        <h1>樂樂單字特訓</h1>
        <div class="controls-area">
            <div class="speed-control">
                <span class="speed-label">語速 (Speed):</span>
                <button class="speed-btn" id="speed-down">－</button>
                <span id="speed-display">0.5</span>
                <button class="speed-btn" id="speed-up">＋</button>
            </div>
            <div class="legend">
                <span class="legend-item legend-noun">n. 名詞</span>
                <span class="legend-item legend-verb">v. 動詞</span>
                <span class="legend-item legend-adj">adj. 形容詞</span>
                <span class="legend-item legend-adv">adv. 副詞</span>
                <span class="legend-item legend-other">other 其他</span>
            </div>
        </div>
    </header>

    <div class="accordion-container" id="app-container"></div>

    <!-- Scroll Nav -->
    <div class="scroll-nav">
        <button class="nav-btn" id="btn-top" title="回到頂部">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        </button>
        <button class="nav-btn micro" id="btn-up" title="向上微調">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 15l-6-6-6 6"/></svg>
        </button>
        <button class="nav-btn micro" id="btn-down" title="向下微調">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <button class="nav-btn" id="btn-bottom" title="到底部">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
        </button>
    </div>

    <script>
        // --- 1. Config & State ---
        let currentSpeed = 0.70;
        const MIN_SPEED = 0.25;
        const MAX_SPEED = 2.00;
        const SPEED_STEP = 0.05;

        // State management for each group
        let groupStates = [];

        // --- 2. Audio ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playFlipSound() {
            initAudio();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        }

        function speak(text, rateOverride) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) { resolve(); return; }
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rateOverride !== undefined ? rateOverride : currentSpeed;
                utterance.onend = resolve;
                utterance.onerror = resolve;
                window.speechSynthesis.speak(utterance);
            });
        }

        async function playFullSequence(word, sentence, btn) {
            if(btn) btn.classList.add('playing');
            await speak(word); // Word
            const spellingRate = Math.max(0.3, currentSpeed - 0.15); 
            const spellingText = word.split('').join(' ');
            await speak(spellingText, spellingRate); // Spelling
            await speak(sentence); // Sentence
            if(btn) btn.classList.remove('playing');
        }

        // --- 3. Helper: Shuffle & POS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getPosType(pos) {
            if (!pos) return "other";
            const p = pos.toLowerCase();
            if (p.includes('n.')) return 'noun';
            if (p.includes('v.')) return 'verb';
            if (p.includes('adj')) return 'adj';
            if (p.includes('adv')) return 'adv';
            return 'other';
        }

        function updateSpeedDisplay() {
            document.getElementById('speed-display').textContent = currentSpeed.toFixed(2);
        }

        // --- 4. Data ---
        // Load vocabulary data from JSON file
        let vocabGroupsRaw = [];
        
        fetch('vocabGroupsRaw.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load vocabulary data');
                    }
                    return response.json();
                })
                .then(data => {
                    vocabGroupsRaw = data;
                    // Initialize states after data is loaded
                    initializeGroupStates();
                    // Render accordions after data is ready
                    renderAccordions();
                })
                .catch(error => {
                    console.error('Error loading vocabulary data:', error);
                    document.getElementById('app-container').innerHTML =
                        '<div class="empty-msg">無法載入單字資料 (Failed to load vocabulary data)</div>';
                });

        function initializeGroupStates() {
            groupStates = [];
            vocabGroupsRaw.forEach((group, idx) => {
            const items = shuffleArray([...group.words]).map((w, i) => ({
                ...w,
                id: i,
                status: 'unanswered'
            }));
            groupStates.push({
                items: items,
                filter: 'unanswered'
            });
            });
        }

        // --- 5. State Logic ---
        // Initialize states for all groups
        vocabGroupsRaw.forEach((group, idx) => {
            const items = shuffleArray([...group.words]).map((w, i) => ({
                ...w,
                id: i,
                status: 'unanswered' // 'unanswered', 'correct', 'incorrect'
            }));
            groupStates.push({
                items: items,
                filter: 'unanswered' // 'unanswered', 'correct', 'incorrect'
            });
        });

        // --- 6. DOM Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Speed Controls
            document.getElementById('speed-down').addEventListener('click', () => {
                if (currentSpeed > MIN_SPEED) {
                    currentSpeed -= SPEED_STEP;
                    if(currentSpeed < MIN_SPEED) currentSpeed = MIN_SPEED;
                    updateSpeedDisplay();
                }
            });
            document.getElementById('speed-up').addEventListener('click', () => {
                if (currentSpeed < MAX_SPEED) {
                    currentSpeed += SPEED_STEP;
                    if(currentSpeed > MAX_SPEED) currentSpeed = MAX_SPEED;
                    updateSpeedDisplay();
                }
            });

            // Scroll Controls
            document.getElementById('btn-top').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('btn-bottom').onclick = () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            document.getElementById('btn-up').onclick = () => window.scrollBy({ top: -280, behavior: 'smooth' });
            document.getElementById('btn-down').onclick = () => window.scrollBy({ top: 280, behavior: 'smooth' });

            renderAccordions();
        });

        function renderAccordions() {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // clear

            vocabGroupsRaw.forEach((group, gIndex) => {
                const accItem = document.createElement('div');
                accItem.className = 'accordion-item';

                const header = document.createElement('div');
                header.className = 'accordion-header';
                if (gIndex === 0) header.classList.add('active');
                header.innerHTML = `
                    <span class="group-title">${group.title}</span>
                    <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                if (gIndex === 0) content.style.maxHeight = "10000px";

                // Tab Bar
                const tabBar = document.createElement('div');
                tabBar.className = 'tab-bar';
                content.appendChild(tabBar);

                // Grid
                const grid = document.createElement('div');
                grid.className = 'card-grid';
                grid.id = `grid-${gIndex}`;
                content.appendChild(grid);

                // Append to DOM
                accItem.appendChild(header);
                accItem.appendChild(content);
                container.appendChild(accItem);

                // Accordion Toggle
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    if (header.classList.contains('active')) {
                        content.style.maxHeight = content.scrollHeight + 500 + "px";
                    } else {
                        content.style.maxHeight = null;
                    }
                });

                // Initial Render of Grid & Tabs
                updateGroupView(gIndex, grid, tabBar);
            });
        }

        function updateGroupView(gIndex, gridElement, tabBarElement) {
            const state = groupStates[gIndex];
            
            // 1. Update Tabs
            const counts = {
                unanswered: state.items.filter(i => i.status === 'unanswered').length,
                correct: state.items.filter(i => i.status === 'correct').length,
                incorrect: state.items.filter(i => i.status === 'incorrect').length
            };

            const total = state.items.length;
            const attempted = total - counts.unanswered;
            const accuracy = attempted > 0 ? Math.round((counts.correct / attempted) * 100) : 0;

            // Tab Config
            const tabs = [
                { key: 'unanswered', label: '繼續', count: counts.unanswered, class: '' },
                { key: 'correct', label: '正確', count: counts.correct, class: 'correct' },
                { key: 'incorrect', label: '錯誤', count: counts.incorrect, class: 'incorrect' }
            ];

            tabBarElement.innerHTML = '';
            
            // Render Tabs
            tabs.forEach(t => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${t.class} ${state.filter === t.key ? 'active' : ''}`;
                btn.innerHTML = `${t.label} <span class="badge">${t.count}</span>`;
                btn.onclick = () => {
                    state.filter = t.key;
                    updateGroupView(gIndex, gridElement, tabBarElement);
                };
                tabBarElement.appendChild(btn);
            });

            // Stats Text
            const statsSpan = document.createElement('span');
            statsSpan.className = 'stats-text';
            statsSpan.textContent = `正確率: ${accuracy}%`;
            tabBarElement.appendChild(statsSpan);

            // Reset Button
            const resetBtn = document.createElement('button');
            resetBtn.className = 'tab-btn reset';
            resetBtn.innerHTML = '↺ 重來';
            resetBtn.onclick = () => {
                state.items.forEach(i => i.status = 'unanswered');
                state.filter = 'unanswered'; // Force view back to continue
                updateGroupView(gIndex, gridElement, tabBarElement);
            };
            tabBarElement.appendChild(resetBtn);

            // 2. Render Grid
            gridElement.innerHTML = '';
            const visibleItems = state.items.filter(item => item.status === state.filter);
            
            // Shuffle visible items before rendering
            shuffleArray(visibleItems);

            if (visibleItems.length === 0) {
                gridElement.innerHTML = `<div class="empty-msg">沒有單字 (No cards)</div>`;
                gridElement.style.display = 'block'; // Ensure message is visible
            } else {
                gridElement.style.display = 'grid';
                visibleItems.forEach(item => {
                    const card = createCard(item, gIndex, () => updateGroupView(gIndex, gridElement, tabBarElement));
                    // If not in 'unanswered' mode, hide grading buttons (optional logic, but usually you grade only once)
                    // However, prompt implies showing list of correct/incorrect cards.
                    // I will hide the grading buttons if we are in 'correct' or 'incorrect' view to prevent double grading.
                    if (state.filter !== 'unanswered') {
                        card.querySelector('.grade-controls').style.display = 'none';
                        // Also adjust padding since buttons are gone
                        card.querySelector('.card-face').style.paddingBottom = '16px';
                    }
                    gridElement.appendChild(card);
                });
            }
            
            // Resize accordion logic
            const content = gridElement.parentElement;
            // Force redraw height if active
            if (content.parentElement.querySelector('.accordion-header').classList.contains('active')) {
                 // Small timeout to allow DOM to settle
                 setTimeout(() => {
                    content.style.maxHeight = (content.scrollHeight + 100) + "px";
                 }, 50);
            }
        }

        function createCard(item, groupIndex, refreshCallback) {
            const theme = getPosType(item.pos);
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';

            const cardContainer = document.createElement('div');
            cardContainer.className = `card-container theme-${theme}`;
            const cardInner = document.createElement('div');
            cardInner.className = 'card-inner';

            // Front: English Word + IPA + Audio
            const frontFace = document.createElement('div');
            frontFace.className = 'card-face card-front';
            
            const wordFront = document.createElement('div');
            wordFront.className = 'word-front';
            wordFront.textContent = item.word;

            const ipaText = document.createElement('div');
            ipaText.className = 'word-ipa';
            ipaText.textContent = item.ipa;

            const frontAudioBtn = document.createElement('button');
            frontAudioBtn.className = 'audio-btn';
            frontAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            frontAudioBtn.onclick = (e) => {
                e.stopPropagation();
                frontAudioBtn.classList.add('playing');
                speak(item.word).then(() => frontAudioBtn.classList.remove('playing'));
            };
            
            frontFace.appendChild(wordFront);
            frontFace.appendChild(ipaText);
            frontFace.appendChild(frontAudioBtn);

            // Back: Chinese + Details + Full Audio
            const backFace = document.createElement('div');
            backFace.className = 'card-face card-back';

            const topSection = document.createElement('div');
            topSection.className = 'top-section';
            
            const posTag = document.createElement('span');
            posTag.className = 'pos-tag';
            posTag.textContent = item.pos;
            
            const wordBack = document.createElement('div');
            wordBack.className = 'word-back-cn';
            wordBack.textContent = item.def;

            topSection.appendChild(posTag);
            topSection.appendChild(wordBack);

            const sentenceBox = document.createElement('div');
            sentenceBox.className = 'sentence-box';
            sentenceBox.textContent = item.sentence;

            const backAudioBtn = document.createElement('button');
            backAudioBtn.className = 'audio-btn';
            backAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            backAudioBtn.onclick = (e) => {
                e.stopPropagation();
                playFullSequence(item.word, item.sentence, backAudioBtn);
            };

            backFace.appendChild(topSection);
            backFace.appendChild(sentenceBox);
            backFace.appendChild(backAudioBtn);

            cardInner.appendChild(frontFace);
            cardInner.appendChild(backFace);
            cardContainer.appendChild(cardInner);

            // Grading Buttons (Floating)
            const controls = document.createElement('div');
            controls.className = 'grade-controls';
            
            const btnIncorrect = document.createElement('button');
            btnIncorrect.className = 'grade-btn btn-incorrect';
            btnIncorrect.innerHTML = '✕'; // X symbol
            btnIncorrect.title = 'Mark as Incorrect';
            btnIncorrect.onclick = (e) => {
                e.stopPropagation();
                markCard(item, 'incorrect', wrapper, refreshCallback);
            };

            const btnCorrect = document.createElement('button');
            btnCorrect.className = 'grade-btn btn-correct';
            btnCorrect.innerHTML = '◯'; // O symbol
            btnCorrect.title = 'Mark as Correct';
            btnCorrect.onclick = (e) => {
                e.stopPropagation();
                markCard(item, 'correct', wrapper, refreshCallback);
            };

            controls.appendChild(btnIncorrect);
            controls.appendChild(btnCorrect);

            // Flip Event
            cardContainer.addEventListener('click', () => {
                if(cardContainer.classList.contains('locked')) return;
                playFlipSound();
                window.speechSynthesis.cancel();
                if (cardContainer.classList.contains('flipped')) {
                    cardContainer.classList.remove('flipped');
                } else {
                    cardContainer.classList.add('flipped');
                }
            });

            wrapper.appendChild(cardContainer);
            wrapper.appendChild(controls);
            return wrapper;
        }

        function markCard(item, status, domElement, refreshCallback) {
            // Animate removal
            domElement.style.transition = "transform 0.3s, opacity 0.3s";
            domElement.style.transform = "scale(0.8)";
            domElement.style.opacity = "0";

            // Update Data after animation
            setTimeout(() => {
                item.status = status;
                refreshCallback();
            }, 300);
        }

    </script>
</body>
</html>
