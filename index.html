<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樂樂單字特訓 (評分過濾版)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --primary-color: #2563eb;
            --text-main: #334155;
            
            --color-correct: #10b981;    /* Green */
            --color-incorrect: #ef4444;  /* Red */
            
            /* POS Colors */
            --color-noun: #3b82f6;
            --color-noun-bg: #eff6ff;
            --color-verb: #ef4444;
            --color-verb-bg: #fef2f2;
            --color-adj: #10b981;
            --color-adj-bg: #ecfdf5;
            --color-adv: #f59e0b;
            --color-adv-bg: #fffbeb;
            --color-other: #8b5cf6;
            --color-other-bg: #f5f3ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            padding-bottom: 120px;
        }

        /* Header */
        header {
            width: 100%;
            max-width: 1200px;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #1e293b;
            letter-spacing: 1px;
        }

        /* Controls Area */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 24px;
            border-radius: 50px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .speed-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #cbd5e1;
            background: #f1f5f9;
            color: #334155;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .speed-btn:active { transform: scale(0.9); background: #e2e8f0; }
        #speed-display { font-family: monospace; font-size: 1.1rem; font-weight: bold; color: var(--primary-color); width: 45px; text-align: center; }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }

        .legend-item {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-weight: 500;
        }

        /* Accordion */
        .accordion-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .accordion-item {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .accordion-header {
            padding: 18px 24px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: background 0.2s;
        }

        .accordion-header:hover { background: #f8fafc; }
        .accordion-header.active { border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .group-title { font-weight: 700; color: #334155; font-size: 1.1rem; }
        .accordion-icon { transition: transform 0.3s; color: #94a3b8; }
        .accordion-header.active .accordion-icon { transform: rotate(180deg); }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: #f8fafc;
        }

        /* Tab Bar inside Accordion */
        .tab-bar {
            display: flex;
            gap: 10px;
            padding: 15px 20px 5px 20px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            align-items: center;
        }

        .tab-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover { background: #f1f5f9; }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-btn.correct.active { background: var(--color-correct); border-color: var(--color-correct); }
        .tab-btn.incorrect.active { background: var(--color-incorrect); border-color: var(--color-incorrect); }

        .tab-btn.reset {
            margin-left: auto; /* Push to right */
            border-color: #cbd5e1;
            color: #475569;
            background: #f8fafc;
        }
        
        .tab-btn.reset:active { background: #e2e8f0; transform: scale(0.95); }

        .badge {
            font-size: 0.75rem;
            padding: 1px 6px;
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
            font-weight: 700;
        }

        .stats-text {
            font-size: 0.8rem;
            color: #64748b;
            margin-left: 10px;
            font-weight: 500;
        }

        /* Grid System */
        .card-grid {
            display: grid;
            padding: 20px;
            gap: 16px;
            min-height: 100px; /* Avoid collapse when empty */
        }

        /* Mobile: 1 Column */
        @media (max-width: 767px) {
            .card-grid { grid-template-columns: 1fr; }
            .tab-bar { padding-bottom: 10px; } /* Scrollbar space */
        }
        /* Desktop: 4 Columns */
        @media (min-width: 1024px) {
            .card-grid { grid-template-columns: repeat(4, 1fr); }
        }
        /* Tablet: 3 Columns */
        @media (min-width: 768px) and (max-width: 1023px) {
            .card-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* Card Component */
        .card-wrapper {
            /* Wrapper to hold the floating buttons */
            position: relative; 
            height: 300px;
        }

        .card-container {
            background: transparent;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            cursor: pointer;
            position: relative;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
        }

        .card-container.flipped .card-inner { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 16px;
            border: 2px solid transparent;
            /* Leave space at bottom for buttons */
            padding-bottom: 60px; 
        }

        .card-front { z-index: 2; transform: rotateY(0deg); }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; }

        /* Grading Buttons (Floating) */
        .grade-controls {
            position: absolute;
            bottom: 12px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 20; /* Above card faces */
            pointer-events: none; /* Allow clicks to pass through gaps */
        }

        .grade-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            pointer-events: auto; /* Re-enable clicks */
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: transform 0.1s, background 0.2s;
            background: white;
        }

        .grade-btn:active { transform: scale(0.9); }
        .btn-correct { color: var(--color-correct); border: 2px solid var(--color-correct); }
        .btn-incorrect { color: var(--color-incorrect); border: 2px solid var(--color-incorrect); }
        
        .btn-correct:hover { background: #ecfdf5; }
        .btn-incorrect:hover { background: #fef2f2; }

        /* Content */
        .word-front { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin-bottom: 8px; word-break: break-word; }
        .word-ipa { font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif; color: #64748b; font-size: 1rem; margin-bottom: 12px; }
        
        .top-section { width: 100%; margin-bottom: 10px; }
        .pos-tag { font-size: 0.8rem; padding: 3px 10px; border-radius: 12px; font-weight: 500; margin-bottom: 6px; display: inline-block; }
        .word-back-cn { font-size: 1.5rem; font-weight: 700; color: #334155; margin-bottom: 4px; }
        
        .sentence-box { 
            background: #f8fafc; 
            border-radius: 8px; 
            padding: 10px; 
            width: 100%; 
            font-size: 0.9rem; 
            color: #475569; 
            font-style: italic; 
            text-align: left; 
            line-height: 1.4; 
            max-height: 80px; 
            overflow-y: auto; 
        }

        /* Audio Btn */
        .audio-btn { background: none; border: 1px solid #cbd5e1; color: #64748b; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .audio-btn:hover { background: #f1f5f9; color: var(--primary-color); border-color: var(--primary-color); }
        .audio-btn.playing { color: #10b981; border-color: #10b981; background: #ecfdf5; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* Themes */
        .theme-noun .card-face { border-top: 5px solid var(--color-noun); } .theme-noun .pos-tag { background: var(--color-noun-bg); color: var(--color-noun); }
        .theme-verb .card-face { border-top: 5px solid var(--color-verb); } .theme-verb .pos-tag { background: var(--color-verb-bg); color: var(--color-verb); }
        .theme-adj .card-face { border-top: 5px solid var(--color-adj); } .theme-adj .pos-tag { background: var(--color-adj-bg); color: var(--color-adj); }
        .theme-adv .card-face { border-top: 5px solid var(--color-adv); } .theme-adv .pos-tag { background: var(--color-adv-bg); color: var(--color-adv); }
        .theme-other .card-face { border-top: 5px solid var(--color-other); } .theme-other .pos-tag { background: var(--color-other-bg); color: var(--color-other); }

        /* Legend */
        .legend-noun { background: var(--color-noun-bg); color: var(--color-noun); border-color: var(--color-noun); }
        .legend-verb { background: var(--color-verb-bg); color: var(--color-verb); border-color: var(--color-verb); }
        .legend-adj { background: var(--color-adj-bg); color: var(--color-adj); border-color: var(--color-adj); }
        .legend-adv { background: var(--color-adv-bg); color: var(--color-adv); border-color: var(--color-adv); }
        .legend-other { background: var(--color-other-bg); color: var(--color-other); border-color: var(--color-other); }

        /* Helper */
        .locked { pointer-events: none; }

    </style>
</head>
<body>

    <header>
        <h1>樂樂單字特訓</h1>
        <div class="controls-area">
            <div class="speed-control">
                <span class="speed-label">語速 (Speed):</span>
                <button class="speed-btn" id="speed-down">－</button>
                <span id="speed-display">0.70</span>
                <button class="speed-btn" id="speed-up">＋</button>
            </div>
            <div class="legend">
                <span class="legend-item legend-noun">n. 名詞</span>
                <span class="legend-item legend-verb">v. 動詞</span>
                <span class="legend-item legend-adj">adj. 形容詞</span>
                <span class="legend-item legend-adv">adv. 副詞</span>
                <span class="legend-item legend-other">other 其他</span>
            </div>
        </div>
    </header>

    <div class="accordion-container" id="app-container"></div>

    <script>
        // --- 1. Config & State ---
        let currentSpeed = 0.70;
        const MIN_SPEED = 0.25;
        const MAX_SPEED = 2.00;
        const SPEED_STEP = 0.05;

        // State management for each group
        // groupStates[groupIndex] = { items: [{id, status: 'unanswered'|'correct'|'incorrect'}], filter: 'unanswered' }
        let groupStates = [];

        // --- 2. Audio ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playFlipSound() {
            initAudio();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        }

        function speak(text, rateOverride) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) { resolve(); return; }
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rateOverride !== undefined ? rateOverride : currentSpeed;
                utterance.onend = resolve;
                utterance.onerror = resolve;
                window.speechSynthesis.speak(utterance);
            });
        }

        async function playFullSequence(word, sentence, btn) {
            if(btn) btn.classList.add('playing');
            await speak(word); // Word
            const spellingRate = Math.max(0.3, currentSpeed - 0.15); 
            const spellingText = word.split('').join(' ');
            await speak(spellingText, spellingRate); // Spelling
            await speak(sentence); // Sentence
            if(btn) btn.classList.remove('playing');
        }

        // --- 3. Data ---
        const vocabGroupsRaw = [
            {
                title: "Dreaming Out Loud",
                words: [
                    { word: "Arena", ipa: "[əˈriːnə]", pos: "n.", def: "體育館、競技場", sentence: "The concert was held in a large arena." },
                    { word: "beat", ipa: "[biːt]", pos: "v.", def: "打破（紀錄）、打敗", sentence: "He beat the world record yesterday." },
                    { word: "billion", ipa: "[ˈbɪljən]", pos: "n.", def: "十億", sentence: "The population reached one billion." },
                    { word: "catchy", ipa: "[ˈkætʃi]", pos: "adj.", def: "朗朗上口的", sentence: "That song has a very catchy tune." },
                    { word: "century", ipa: "[ˈsentʃəri]", pos: "n.", def: "世紀", sentence: "We are living in the 21st century." },
                    { word: "chances", ipa: "[ˈtʃænsɪz]", pos: "n.", def: "機會、可能性", sentence: "Chances are it will rain today." },
                    { word: "clearly", ipa: "[ˈklɪəli]", pos: "adv.", def: "清楚地、顯然", sentence: "He spoke clearly so everyone could hear." },
                    { word: "Dreaming Out Loud", ipa: "", pos: "n.", def: "大聲做夢（專輯）", sentence: "Dreaming Out Loud is a famous album." },
                    { word: "feature", ipa: "[ˈfiːtʃə]", pos: "n.", def: "特色、重點", sentence: "The main feature is its camera." },
                    { word: "film", ipa: "[fɪlm]", pos: "n.", def: "電影", sentence: "We watched an interesting film." },
                    { word: "household", ipa: "[ˈhaʊshəʊld]", pos: "adj.", def: "家庭的", sentence: "This brand is a household name." },
                    { word: "huge", ipa: "[hjuːdʒ]", pos: "adj.", def: "巨大的", sentence: "The elephant is a huge animal." },
                    { word: "immediate", ipa: "[ɪˈmiːdiət]", pos: "adj.", def: "立即的", sentence: "We need an immediate response." },
                    { word: "island", ipa: "[ˈaɪlənd]", pos: "n.", def: "島嶼", sentence: "They live on a tropical island." },
                    { word: "latest", ipa: "[ˈleɪtɪst]", pos: "adj.", def: "最新的", sentence: "Have you seen the latest news?" },
                    { word: "least", ipa: "[liːst]", pos: "adj.", def: "最少", sentence: "That was the least interesting part." },
                    { word: "million", ipa: "[ˈmɪljən]", pos: "n.", def: "百萬", sentence: "She won a million dollars." },
                    { word: "monthly", ipa: "[ˈmʌnθli]", pos: "adv.", def: "每月的", sentence: "I pay my bills monthly." },
                    { word: "mutual", ipa: "[ˈmjuːtʃuəl]", pos: "adj.", def: "相互的", sentence: "Respect is a mutual feeling." },
                    { word: "perform", ipa: "[pəˈfɔːm]", pos: "v.", def: "表演", sentence: "The band will perform live tonight." },
                    { word: "predicted", ipa: "[prɪˈdɪktɪd]", pos: "v.", def: "預測 (過去式)", sentence: "The weatherman predicted snow." },
                    { word: "reason", ipa: "[ˈriːzn]", pos: "n.", def: "原因", sentence: "What is the reason for your visit?" },
                    { word: "relate", ipa: "[rɪˈleɪt]", pos: "v.", def: "理解、共鳴", sentence: "I can relate to your problem." },
                    { word: "resonate", ipa: "[ˈrezəneɪt]", pos: "v.", def: "引起共鳴", sentence: "His speech resonated with the crowd." },
                    { word: "Since", ipa: "[sɪns]", pos: "conj.", def: "自從", sentence: "I haven't seen him since Monday." },
                    { word: "Spotify", ipa: "[ˈspɒtɪfaɪ]", pos: "n.", def: "Spotify", sentence: "I listen to music on Spotify." },
                    { word: "stolen", ipa: "[ˈstəʊlən]", pos: "v.", def: "偷走", sentence: "My wallet was stolen yesterday." },
                    { word: "streams", ipa: "[striːmz]", pos: "n.", def: "串流次數", sentence: "The song has millions of streams." },
                    { word: "studio", ipa: "[ˈstjuːdiəʊ]", pos: "n.", def: "錄音室", sentence: "They recorded in a studio." },
                    { word: "talents", ipa: "[ˈtælənts]", pos: "n.", def: "天賦、才華", sentence: "She has many artistic talents." }
                ]
            },
            {
                title: "Super Dogs Find Water Leaks",
                words: [
                    { word: "as deep as", ipa: "[æz diːp æz]", pos: "phr.", def: "深達", sentence: "The water is as deep as the ocean." },
                    { word: "break underground", ipa: "[breɪk ˌʌndəˈɡraʊnd]", pos: "phr.", def: "在地下破裂", sentence: "Pipes often break underground." },
                    { word: "capable of", ipa: "[ˈkeɪpəbl ɒv]", pos: "phr.", def: "能夠", sentence: "He is capable of running fast." },
                    { word: "chemical", ipa: "[ˈkemɪkl]", pos: "n.", def: "化學物質", sentence: "Be careful with that chemical." },
                    { word: "chlorine", ipa: "[ˈklɔːriːn]", pos: "n.", def: "氯", sentence: "There is chlorine in the swimming pool." },
                    { word: "clever", ipa: "[ˈklevə]", pos: "adj.", def: "聰明的", sentence: "The clever dog learned a new trick." },
                    { word: "detect", ipa: "[dɪˈtekt]", pos: "v.", def: "偵測", sentence: "The machine can detect smoke." },
                    { word: "dig up", ipa: "[dɪɡ ʌp]", pos: "phr.", def: "挖出", sentence: "The dog tried to dig up a bone." },
                    { word: "exact", ipa: "[ɪɡˈzækt]", pos: "adj.", def: "確切的", sentence: "I need the exact measurements." },
                    { word: "fix", ipa: "[fɪks]", pos: "v.", def: "修理", sentence: "Can you fix my bike?" },
                    { word: "France", ipa: "[frɑːns]", pos: "n.", def: "法國", sentence: "Paris is in France." },
                    { word: "however", ipa: "[haʊˈevə]", pos: "adv.", def: "然而", sentence: "It was cold; however, we went out." },
                    { word: "important", ipa: "[ɪmˈpɔːtnt]", pos: "adj.", def: "重要的", sentence: "Water is important for life." },
                    { word: "leak", ipa: "[liːk]", pos: "v.", def: "洩漏", sentence: "The roof started to leak." },
                    { word: "locate", ipa: "[ləʊˈkeɪt]", pos: "v.", def: "找出位置", sentence: "Can you locate the store?" },
                    { word: "mark", ipa: "[mɑːk]", pos: "v.", def: "標記", sentence: "Please mark the correct answer." },
                    { word: "may", ipa: "[meɪ]", pos: "aux.", def: "可能", sentence: "It may rain later today." },
                    { word: "moreover", ipa: "[mɔːrˈəʊvə]", pos: "adv.", def: "此外", sentence: "The car is fast; moreover, it is cheap." },
                    { word: "once", ipa: "[wʌns]", pos: "adv.", def: "一旦", sentence: "Once you start, don't stop." },
                    { word: "powerful", ipa: "[ˈpaʊəfl]", pos: "adj.", def: "強而有力的", sentence: "The engine is very powerful." },
                    { word: "prevent", ipa: "[prɪˈvent]", pos: "v.", def: "預防", sentence: "Wash hands to prevent illness." },
                    { word: "reach", ipa: "[riːtʃ]", pos: "v.", def: "到達", sentence: "We will reach the top soon." },
                    { word: "shortage", ipa: "[ˈʃɔːtɪdʒ]", pos: "n.", def: "短缺", sentence: "There is a shortage of food." },
                    { word: "sniff out", ipa: "[snɪf aʊt]", pos: "phr.", def: "嗅；聞", sentence: "Dogs can sniff out hidden items." },
                    { word: "spot", ipa: "[spɒt]", pos: "n.", def: "地點", sentence: "This is a nice spot for a picnic." },
                    { word: "sense of smell", ipa: "[sens ɒv smel]", pos: "phr.", def: "嗅覺", sentence: "Dogs have a good sense of smell." },
                    { word: "tap water", ipa: "[tæp ˈwɔːtə]", pos: "n.", def: "自來水", sentence: "Is the tap water safe?" },
                    { word: "traditional", ipa: "[trəˈdɪʃənl]", pos: "adj.", def: "傳統的", sentence: "They wore traditional clothes." },
                    { word: "train", ipa: "[treɪn]", pos: "v.", def: "訓練", sentence: "Athletes train every day." },
                    { word: "turns into", ipa: "[tɜːnz ˈɪntə]", pos: "phr.", def: "轉變為", sentence: "Water turns into ice." }
                ]
            },
            {
                title: "The Salty Story of the Dead Sea",
                words: [
                    { word: "Actually", ipa: "[ˈæktʃuəli]", pos: "adv.", def: "實際上", sentence: "Actually, I prefer tea." },
                    { word: "as though", ipa: "[æz ðəʊ]", pos: "phr.", def: "彷彿", sentence: "He looked as though he was tired." },
                    { word: "couch", ipa: "[kaʊtʃ]", pos: "n.", def: "沙發", sentence: "I sat on the couch." },
                    { word: "deserts", ipa: "[ˈdezəts]", pos: "n.", def: "沙漠", sentence: "Camels live in deserts." },
                    { word: "evaporates", ipa: "[ɪˈvæpəreɪts]", pos: "v.", def: "蒸發", sentence: "Water evaporates in the sun." },
                    { word: "experience", ipa: "[ɪkˈspɪəriəns]", pos: "n.", def: "體驗", sentence: "It was a wonderful experience." },
                    { word: "flowing into", ipa: "[ˈfləʊɪŋ ˈɪntə]", pos: "phr.", def: "流入", sentence: "The river is flowing into the sea." },
                    { word: "landlocked", ipa: "[ˈlændlɒkt]", pos: "adj.", def: "被陸地包圍的", sentence: "Switzerland is landlocked." },
                    { word: "lie", ipa: "[laɪ]", pos: "v.", def: "躺", sentence: "I like to lie on the grass." },
                    { word: "ocean", ipa: "[ˈəʊʃn]", pos: "n.", def: "海洋", sentence: "The ocean is vast and blue." },
                    { word: "rocks", ipa: "[rɒks]", pos: "n.", def: "岩石", sentence: "We climbed over the rocks." },
                    { word: "salt", ipa: "[sɔːlt]", pos: "n.", def: "鹽", sentence: "Please pass the salt." },
                    { word: "saltier", ipa: "[ˈsɔːltiə]", pos: "adj.", def: "更鹹的", sentence: "This soup tastes saltier." },
                    { word: "Since", ipa: "[sɪns]", pos: "conj.", def: "因為", sentence: "Since it rained, we stayed in." },
                    { word: "strange", ipa: "[streɪndʒ]", pos: "adj.", def: "奇怪的", sentence: "That is a strange sound." },
                    { word: "Surprisingly", ipa: "[səˈpraɪzɪŋli]", pos: "adv.", def: "令人驚訝地", sentence: "Surprisingly, he won." },
                    { word: "survive", ipa: "[səˈvaɪv]", pos: "v.", def: "生存", sentence: "Animals need water to survive." },
                    { word: "themselves", ipa: "[ðəmˈselvz]", pos: "pron.", def: "他們自己", sentence: "They did it themselves." },
                    { word: "Therefore", ipa: "[ˈðeəfɔː]", pos: "adv.", def: "因此", sentence: "I was sick; therefore, I stayed home." },
                    { word: "truly", ipa: "[ˈtruːli]", pos: "adv.", def: "真正地", sentence: "I am truly sorry." },
                    { word: "vapor", ipa: "[ˈveɪpə]", pos: "n.", def: "水氣", sentence: "Water vapor rises." },
                    { word: "West Bank", ipa: "[west bæŋk]", pos: "n.", def: "西岸地區", sentence: "It is near the West Bank." },
                    { word: "until", ipa: "[ənˈtɪl]", pos: "conj.", def: "直到", sentence: "Wait until I return." }
                ]
            },
            {
                title: "Smangus: Ancient Forest (Part 2)",
                words: [
                    { word: "Along", ipa: "[əˈlɒŋ]", pos: "prep.", def: "沿著", sentence: "We walked along the river." },
                    { word: "Although", ipa: "[ɔːlˈðəʊ]", pos: "conj.", def: "雖然", sentence: "Although it rained, we played." },
                    { word: "among", ipa: "[əˈmʌŋ]", pos: "prep.", def: "在...之中", sentence: "He sat among friends." },
                    { word: "asleep", ipa: "[əˈsliːp]", pos: "adj.", def: "睡著的", sentence: "The baby is fast asleep." },
                    { word: "Atayal", ipa: "[əˈtaɪəl]", pos: "n.", def: "泰雅族", sentence: "The Atayal people are indigenous." },
                    { word: "bamboo", ipa: "[ˌbæmˈbuː]", pos: "n.", def: "竹子", sentence: "Pandas eat bamboo." },
                    { word: "bird-watchers", ipa: "[bɜːd ˈwɒtʃəz]", pos: "n.", def: "賞鳥者", sentence: "Bird-watchers enjoy nature." },
                    { word: "breeze", ipa: "[briːz]", pos: "n.", def: "微風", sentence: "A cool breeze blew." },
                    { word: "decision", ipa: "[dɪˈsɪʒn]", pos: "n.", def: "決定", sentence: "He made a quick decision." },
                    { word: "deep", ipa: "[diːp]", pos: "adj.", def: "深處的", sentence: "They went deep into the woods." },
                    { word: "destination", ipa: "[ˌdestɪˈneɪʃn]", pos: "n.", def: "目的地", sentence: "We reached our destination." },
                    { word: "Ecological", ipa: "[ˌiːkəˈlɒdʒɪkl]", pos: "adj.", def: "生態的", sentence: "Ecological protection is key." },
                    { word: "environment", ipa: "[ɪnˈvaɪrənmənt]", pos: "n.", def: "環境", sentence: "Protect the environment." },
                    { word: "especially", ipa: "[ɪˈspeʃəli]", pos: "adv.", def: "尤其", sentence: "I like fruit, especially apples." },
                    { word: "exactly", ipa: "[ɪɡˈzæktli]", pos: "adv.", def: "正是", sentence: "That is exactly right." },
                    { word: "farmland", ipa: "[ˈfɑːmlænd]", pos: "n.", def: "農田", sentence: "The farmland is green." },
                    { word: "fertile", ipa: "[ˈfɜːtaɪl]", pos: "adj.", def: "肥沃的", sentence: "The soil is fertile." },
                    { word: "finally", ipa: "[ˈfaɪnəli]", pos: "adv.", def: "終於", sentence: "Finally, we arrived." },
                    { word: "forest", ipa: "[ˈfɒrɪst]", pos: "n.", def: "森林", sentence: "Bears live in the forest." },
                    { word: "hesitation", ipa: "[ˌhezɪˈteɪʃn]", pos: "n.", def: "猶豫", sentence: "He answered without hesitation." },
                    { word: "hike", ipa: "[haɪk]", pos: "v.", def: "健行", sentence: "We plan to hike." },
                    { word: "Hsinchu", ipa: "[ˈʃɪnˈtʃuː]", pos: "n.", def: "新竹", sentence: "Hsinchu is windy." },
                    { word: "Koraw", ipa: "", pos: "n.", def: "科拉（地名）", sentence: "Koraw is beautiful." },
                    { word: "landscapes", ipa: "[ˈlændskeɪps]", pos: "n.", def: "風景", sentence: "The landscapes are nice." },
                    { word: "last-minute", ipa: "[lɑːst ˈmɪnɪt]", pos: "adj.", def: "最後一刻", sentence: "A last-minute change." },
                    { word: "leaves", ipa: "[liːvz]", pos: "n.", def: "葉子", sentence: "Leaves turn red in fall." },
                    { word: "mountain", ipa: "[ˈmaʊntən]", pos: "n.", def: "山", sentence: "The mountain is high." },
                    { word: "notice", ipa: "[ˈnəʊtɪs]", pos: "v.", def: "注意到", sentence: "Did you notice that?" },
                    { word: "observe", ipa: "[əbˈzɜːv]", pos: "v.", def: "觀察", sentence: "Scientists observe stars." },
                    { word: "offered", ipa: "[ˈɒfəd]", pos: "v.", def: "提供", sentence: "He offered to help." },
                    { word: "originally", ipa: "[əˈrɪdʒɪnəli]", pos: "adv.", def: "起初", sentence: "It was originally blue." },
                    { word: "outdoor", ipa: "[ˈaʊtdɔː]", pos: "adj.", def: "戶外的", sentence: "We like outdoor fun." },
                    { word: "Park", ipa: "[pɑːk]", pos: "n.", def: "公園", sentence: "Let's go to the park." },
                    { word: "peaceful", ipa: "[ˈpiːsfl]", pos: "adj.", def: "平靜的", sentence: "It is very peaceful." },
                    { word: "pink", ipa: "[pɪŋk]", pos: "adj.", def: "粉紅色", sentence: "She wore pink." },
                    { word: "quite", ipa: "[kwaɪt]", pos: "adv.", def: "相當", sentence: "It is quite cold." },
                    { word: "refers", ipa: "[rɪˈfɜːz]", pos: "v.", def: "指的是", sentence: "This refers to a plant." },
                    { word: "ride", ipa: "[raɪd]", pos: "n.", def: "旅程", sentence: "The ride was long." },
                    { word: "rise", ipa: "[raɪz]", pos: "v.", def: "升起", sentence: "The sun will rise." },
                    { word: "roads", ipa: "[rəʊdz]", pos: "n.", def: "道路", sentence: "The roads are wet." },
                    { word: "roofs", ipa: "[ruːfs]", pos: "n.", def: "屋頂", sentence: "Red roofs." },
                    { word: "rough", ipa: "[rʌf]", pos: "adj.", def: "崎嶇的", sentence: "The road was rough." },
                    { word: "satisfied", ipa: "[ˈsætɪsfaɪd]", pos: "adj.", def: "滿意的", sentence: "I am satisfied." },
                    { word: "selection", ipa: "[sɪˈlekʃn]", pos: "n.", def: "選擇", sentence: "Good selection of food." },
                    { word: "shady", ipa: "[ˈʃeɪdi]", pos: "adj.", def: "蔭涼的", sentence: "A shady spot." },
                    { word: "sharp", ipa: "[ʃɑːp]", pos: "adj.", def: "急劇的", sentence: "A sharp turn." },
                    { word: "Smangus", ipa: "", pos: "n.", def: "司馬庫斯", sentence: "Smangus is a tribe." },
                    { word: "spot", ipa: "[spɒt]", pos: "n.", def: "地點", sentence: "X marks the spot." },
                    { word: "streams", ipa: "[striːmz]", pos: "n.", def: "溪流", sentence: "Streams flow to rivers." },
                    { word: "toward", ipa: "[təˈwɔːd]", pos: "prep.", def: "朝向", sentence: "He walked toward me." },
                    { word: "Trail", ipa: "[treɪl]", pos: "n.", def: "步道", sentence: "We hiked the trail." },
                    { word: "until", ipa: "[ənˈtɪl]", pos: "conj.", def: "直到", sentence: "Wait until green." },
                    { word: "village", ipa: "[ˈvɪlɪdʒ]", pos: "n.", def: "村落", sentence: "A small village." },
                    { word: "wildlife", ipa: "[ˈwaɪldlaɪf]", pos: "n.", def: "野生生物", sentence: "Lots of wildlife." }
                ]
            },
            {
                title: "Hot Tech, Cool Ideas",
                words: [
                    { word: "achieve", ipa: "[əˈtʃiːv]", pos: "v.", def: "達成", sentence: "Work hard to achieve goals." },
                    { word: "agriculture", ipa: "[ˈæɡrɪkʌltʃə]", pos: "n.", def: "農業", sentence: "Agriculture feeds us." },
                    { word: "although", ipa: "[ɔːlˈðəʊ]", pos: "conj.", def: "雖然", sentence: "Although young, he is smart." },
                    { word: "approach", ipa: "[əˈprəʊtʃ]", pos: "n.", def: "方法", sentence: "A new approach." },
                    { word: "attractive", ipa: "[əˈtræktɪv]", pos: "adj.", def: "吸引人的", sentence: "An attractive offer." },
                    { word: "conditions", ipa: "[kənˈdɪʃnz]", pos: "n.", def: "條件", sentence: "Good conditions." },
                    { word: "cooling", ipa: "[ˈkuːlɪŋ]", pos: "n.", def: "冷卻", sentence: "The cooling system." },
                    { word: "dealing", ipa: "[ˈdiːlɪŋ]", pos: "v.", def: "處理", sentence: "Dealing with problems." },
                    { word: "decade", ipa: "[ˈdekeɪd]", pos: "n.", def: "十年", sentence: "A decade is ten years." },
                    { word: "demonstrated", ipa: "[ˈdemənstreɪtɪd]", pos: "v.", def: "證明", sentence: "She demonstrated it." },
                    { word: "denying", ipa: "[dɪˈnaɪɪŋ]", pos: "v.", def: "否認", sentence: "No denying it." },
                    { word: "development", ipa: "[dɪˈveləpmənt]", pos: "n.", def: "發展", sentence: "Tech development." },
                    { word: "directly", ipa: "[dɪˈrektli]", pos: "adv.", def: "直接", sentence: "Go directly home." },
                    { word: "electricity", ipa: "[ɪˌlekˈtrɪsəti]", pos: "n.", def: "電力", sentence: "We need electricity." },
                    { word: "Finland", ipa: "[ˈfɪnlənd]", pos: "n.", def: "芬蘭", sentence: "Finland is cold." },
                    { word: "further", ipa: "[ˈfɜːðə]", pos: "adv.", def: "進一步", sentence: "For further information, call us." },
                    { word: "harness", ipa: "[ˈhɑːnɪs]", pos: "v.", def: "利用", sentence: "Harness the wind." },
                    { word: "imported", ipa: "[ɪmˈpɔːtɪd]", pos: "v.", def: "進口", sentence: "Imported goods." },
                    { word: "inefficient", ipa: "[ˌɪnɪˈfɪʃnt]", pos: "adj.", def: "低效", sentence: "Inefficient engine." },
                    { word: "instead", ipa: "[ɪnˈsted]", pos: "adv.", def: "代替", sentence: "Water instead of soda." },
                    { word: "literally", ipa: "[ˈlɪtərəli]", pos: "adv.", def: "字面上", sentence: "He literally ran." },
                    { word: "majority", ipa: "[məˈdʒɒrəti]", pos: "n.", def: "大多數", sentence: "The majority agree." },
                    { word: "Mäntsälä", ipa: "", pos: "n.", def: "曼采萊", sentence: "A town in Finland." },
                    { word: "nearby", ipa: "[ˌnɪəˈbaɪ]", pos: "adj.", def: "附近", sentence: "A store nearby." },
                    { word: "obvious", ipa: "[ˈɒbviəs]", pos: "adj.", def: "明顯", sentence: "It is obvious." },
                    { word: "pack", ipa: "[pæk]", pos: "v.", def: "擠滿", sentence: "Fans pack the stadium." },
                    { word: "particularly", ipa: "[pəˈtɪkjələli]", pos: "adv.", def: "尤其", sentence: "Particularly cold." },
                    { word: "Perhaps", ipa: "[pəˈhæps]", pos: "adv.", def: "也許", sentence: "Perhaps tomorrow." },
                    { word: "possible", ipa: "[ˈpɒsəbl]", pos: "adj.", def: "可能", sentence: "It is possible." },
                    { word: "proves", ipa: "[pruːvz]", pos: "v.", def: "證明", sentence: "It proves he is right." },
                    { word: "race ahead", ipa: "[reɪs əˈhed]", pos: "phr.", def: "超前", sentence: "He raced ahead." },
                    { word: "Recycling", ipa: "[ˌriːˈsaɪklɪŋ]", pos: "n.", def: "回收", sentence: "Recycling helps." },
                    { word: "rid", ipa: "[rɪd]", pos: "v.", def: "擺脫", sentence: "Get rid of it." },
                    { word: "scale", ipa: "[skeɪl]", pos: "n.", def: "規模", sentence: "Large scale." },
                    { word: "soaring", ipa: "[ˈsɔːrɪŋ]", pos: "adj.", def: "飆升", sentence: "Prices are soaring." },
                    { word: "Solve", ipa: "[sɒlv]", pos: "v.", def: "解決", sentence: "Solve the problem." },
                    { word: "Sweden", ipa: "[ˈswiːdn]", pos: "n.", def: "瑞典", sentence: "Sweden is in Europe." },
                    { word: "technology", ipa: "[tekˈnɒlədʒi]", pos: "n.", def: "科技", sentence: "Modern technology." },
                    { word: "through", ipa: "[θruː]", pos: "prep.", def: "透過", sentence: "Through practice." },
                    { word: "typically", ipa: "[ˈtɪpɪkli]", pos: "adv.", def: "通常", sentence: "Typically hot." },
                    { word: "unclear", ipa: "[ˌʌnˈklɪə]", pos: "adj.", def: "不清楚", sentence: "It is unclear." },
                    { word: "warm", ipa: "[wɔːm]", pos: "v.", def: "加熱", sentence: "Warm it up." },
                    { word: "Waste-Heat", ipa: "[weɪst hiːt]", pos: "n.", def: "廢熱", sentence: "Reuse waste-heat." },
                    { word: "wherever", ipa: "[weərˈevə]", pos: "adv.", def: "無論", sentence: "Go wherever." },
                    { word: "Whether", ipa: "[ˈweðə]", pos: "conj.", def: "是否", sentence: "Whether to go." },
                    { word: "While", ipa: "[waɪl]", pos: "conj.", def: "雖然", sentence: "While nice, it is pricey." }
                ]
            }
        ];

        // --- 4. Helper: POS Type ---
        function getPosType(pos) {
            if (!pos) return "other";
            const p = pos.toLowerCase();
            if (p.includes('n.')) return 'noun';
            if (p.includes('v.')) return 'verb';
            if (p.includes('adj')) return 'adj';
            if (p.includes('adv')) return 'adv';
            return 'other';
        }

        function updateSpeedDisplay() {
            document.getElementById('speed-display').textContent = currentSpeed.toFixed(2);
        }

        // Shuffle (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 5. State Logic ---
        // Initialize states for all groups
        vocabGroupsRaw.forEach((group, idx) => {
            const items = shuffleArray([...group.words]).map((w, i) => ({
                ...w,
                id: i,
                status: 'unanswered' // 'unanswered', 'correct', 'incorrect'
            }));
            groupStates.push({
                items: items,
                filter: 'unanswered' // 'unanswered', 'correct', 'incorrect'
            });
        });

        // --- 6. DOM Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Speed Controls
            document.getElementById('speed-down').addEventListener('click', () => {
                if (currentSpeed > MIN_SPEED) {
                    currentSpeed -= SPEED_STEP;
                    if(currentSpeed < MIN_SPEED) currentSpeed = MIN_SPEED;
                    updateSpeedDisplay();
                }
            });
            document.getElementById('speed-up').addEventListener('click', () => {
                if (currentSpeed < MAX_SPEED) {
                    currentSpeed += SPEED_STEP;
                    if(currentSpeed > MAX_SPEED) currentSpeed = MAX_SPEED;
                    updateSpeedDisplay();
                }
            });

            // Scroll Controls
            document.getElementById('btn-top').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('btn-bottom').onclick = () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            document.getElementById('btn-up').onclick = () => window.scrollBy({ top: -280, behavior: 'smooth' });
            document.getElementById('btn-down').onclick = () => window.scrollBy({ top: 280, behavior: 'smooth' });

            renderAccordions();
        });

        function renderAccordions() {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // clear

            vocabGroupsRaw.forEach((group, gIndex) => {
                const accItem = document.createElement('div');
                accItem.className = 'accordion-item';

                const header = document.createElement('div');
                header.className = 'accordion-header';
                if (gIndex === 0) header.classList.add('active');
                header.innerHTML = `
                    <span class="group-title">${group.title}</span>
                    <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                if (gIndex === 0) content.style.maxHeight = "10000px";

                // Tab Bar
                const tabBar = document.createElement('div');
                tabBar.className = 'tab-bar';
                content.appendChild(tabBar);

                // Grid
                const grid = document.createElement('div');
                grid.className = 'card-grid';
                grid.id = `grid-${gIndex}`;
                content.appendChild(grid);

                // Append to DOM
                accItem.appendChild(header);
                accItem.appendChild(content);
                container.appendChild(accItem);

                // Accordion Toggle
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    if (header.classList.contains('active')) {
                        content.style.maxHeight = content.scrollHeight + 500 + "px";
                    } else {
                        content.style.maxHeight = null;
                    }
                });

                // Initial Render of Grid & Tabs
                updateGroupView(gIndex, grid, tabBar);
            });
        }

        function updateGroupView(gIndex, gridElement, tabBarElement) {
            const state = groupStates[gIndex];
            
            // 1. Update Tabs
            const counts = {
                unanswered: state.items.filter(i => i.status === 'unanswered').length,
                correct: state.items.filter(i => i.status === 'correct').length,
                incorrect: state.items.filter(i => i.status === 'incorrect').length
            };

            const total = state.items.length;
            const attempted = total - counts.unanswered;
            const accuracy = attempted > 0 ? Math.round((counts.correct / attempted) * 100) : 0;

            // Tab Config
            const tabs = [
                { key: 'unanswered', label: '繼續', count: counts.unanswered, class: '' },
                { key: 'correct', label: '正確', count: counts.correct, class: 'correct' },
                { key: 'incorrect', label: '錯誤', count: counts.incorrect, class: 'incorrect' }
            ];

            tabBarElement.innerHTML = '';
            
            // Render Tabs
            tabs.forEach(t => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${t.class} ${state.filter === t.key ? 'active' : ''}`;
                btn.innerHTML = `${t.label} <span class="badge">${t.count}</span>`;
                btn.onclick = () => {
                    state.filter = t.key;
                    updateGroupView(gIndex, gridElement, tabBarElement);
                };
                tabBarElement.appendChild(btn);
            });

            // Stats Text
            const statsSpan = document.createElement('span');
            statsSpan.className = 'stats-text';
            statsSpan.textContent = `正確率: ${accuracy}%`;
            tabBarElement.appendChild(statsSpan);

            // Reset Button
            const resetBtn = document.createElement('button');
            resetBtn.className = 'tab-btn reset';
            resetBtn.innerHTML = '↺ 重來';
            resetBtn.onclick = () => {
                if(confirm('確定要重置此群組的學習進度嗎？')) {
                    state.items.forEach(i => i.status = 'unanswered');
                    state.filter = 'unanswered'; // Force view back to continue
                    updateGroupView(gIndex, gridElement, tabBarElement);
                }
            };
            tabBarElement.appendChild(resetBtn);

            // 2. Render Grid
            gridElement.innerHTML = '';
            const visibleItems = state.items.filter(item => item.status === state.filter);

            if (visibleItems.length === 0) {
                gridElement.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#94a3b8; padding:40px;">沒有單字 (No cards)</div>`;
                gridElement.style.display = 'block'; // Ensure message is visible
            } else {
                gridElement.style.display = 'grid';
                visibleItems.forEach(item => {
                    const card = createCard(item, gIndex, () => updateGroupView(gIndex, gridElement, tabBarElement));
                    // If not in 'unanswered' mode, hide grading buttons (optional logic, but usually you grade only once)
                    // However, prompt implies showing list of correct/incorrect cards.
                    // I will hide the grading buttons if we are in 'correct' or 'incorrect' view to prevent double grading.
                    if (state.filter !== 'unanswered') {
                        card.querySelector('.grade-controls').style.display = 'none';
                        // Also adjust padding since buttons are gone
                        card.querySelector('.card-front').style.paddingBottom = '16px';
                        card.querySelector('.card-back').style.paddingBottom = '16px';
                    }
                    gridElement.appendChild(card);
                });
            }
            
            // Resize accordion logic
            const content = gridElement.parentElement;
            // Force redraw height if active
            if (content.parentElement.querySelector('.accordion-header').classList.contains('active')) {
                 // Small timeout to allow DOM to settle
                 setTimeout(() => {
                    content.style.maxHeight = (content.scrollHeight + 100) + "px";
                 }, 50);
            }
        }

        function createCard(item, groupIndex, refreshCallback) {
            const theme = getPosType(item.pos);
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';

            const cardContainer = document.createElement('div');
            cardContainer.className = `card-container theme-${theme}`;
            const cardInner = document.createElement('div');
            cardInner.className = 'card-inner';

            // Front: English Word + IPA + Audio
            const frontFace = document.createElement('div');
            frontFace.className = 'card-face card-front';
            
            const wordFront = document.createElement('div');
            wordFront.className = 'word-front';
            wordFront.textContent = item.word;

            const ipaText = document.createElement('div');
            ipaText.className = 'word-ipa';
            ipaText.textContent = item.ipa;

            const frontAudioBtn = document.createElement('button');
            frontAudioBtn.className = 'audio-btn';
            frontAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            frontAudioBtn.onclick = (e) => {
                e.stopPropagation();
                frontAudioBtn.classList.add('playing');
                speak(item.word).then(() => frontAudioBtn.classList.remove('playing'));
            };
            
            frontFace.appendChild(wordFront);
            frontFace.appendChild(ipaText);
            frontFace.appendChild(frontAudioBtn);

            // Back: Chinese + Details + Full Audio
            const backFace = document.createElement('div');
            backFace.className = 'card-face card-back';

            const topSection = document.createElement('div');
            topSection.className = 'top-section';
            
            const posTag = document.createElement('span');
            posTag.className = 'pos-tag';
            posTag.textContent = item.pos;
            
            const wordBack = document.createElement('div');
            wordBack.className = 'word-back-cn';
            wordBack.textContent = item.def;

            topSection.appendChild(posTag);
            topSection.appendChild(wordBack);

            const sentenceBox = document.createElement('div');
            sentenceBox.className = 'sentence-box';
            sentenceBox.textContent = item.sentence;

            const backAudioBtn = document.createElement('button');
            backAudioBtn.className = 'audio-btn';
            backAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            backAudioBtn.onclick = (e) => {
                e.stopPropagation();
                playFullSequence(item.word, item.sentence, backAudioBtn);
            };

            backFace.appendChild(topSection);
            backFace.appendChild(sentenceBox);
            backFace.appendChild(backAudioBtn);

            cardInner.appendChild(frontFace);
            cardInner.appendChild(backFace);
            cardContainer.appendChild(cardInner);

            // Grading Buttons (Floating)
            const controls = document.createElement('div');
            controls.className = 'grade-controls';
            
            const btnIncorrect = document.createElement('button');
            btnIncorrect.className = 'grade-btn btn-incorrect';
            btnIncorrect.innerHTML = '✕'; // X symbol
            btnIncorrect.title = 'Mark as Incorrect';
            btnIncorrect.onclick = (e) => {
                e.stopPropagation();
                markCard(item, 'incorrect', wrapper, refreshCallback);
            };

            const btnCorrect = document.createElement('button');
            btnCorrect.className = 'grade-btn btn-correct';
            btnCorrect.innerHTML = '◯'; // O symbol
            btnCorrect.title = 'Mark as Correct';
            btnCorrect.onclick = (e) => {
                e.stopPropagation();
                markCard(item, 'correct', wrapper, refreshCallback);
            };

            controls.appendChild(btnIncorrect);
            controls.appendChild(btnCorrect);

            // Flip Event
            cardContainer.addEventListener('click', () => {
                if(cardContainer.classList.contains('locked')) return;
                playFlipSound();
                window.speechSynthesis.cancel();
                if (cardContainer.classList.contains('flipped')) {
                    cardContainer.classList.remove('flipped');
                } else {
                    cardContainer.classList.add('flipped');
                }
            });

            wrapper.appendChild(cardContainer);
            wrapper.appendChild(controls);
            return wrapper;
        }

        function markCard(item, status, domElement, refreshCallback) {
            // Animate removal
            domElement.style.transition = "transform 0.3s, opacity 0.3s";
            domElement.style.transform = "scale(0.8)";
            domElement.style.opacity = "0";

            // Update Data after animation
            setTimeout(() => {
                item.status = status;
                refreshCallback();
            }, 300);
        }

    </script>
</body>
</html>
